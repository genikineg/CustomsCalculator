"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.deadlineMiddleware = void 0;
const nice_grpc_common_1 = require("nice-grpc-common");
const node_abort_controller_1 = __importDefault(require("node-abort-controller"));
const deadlineMiddleware = async function* deadlineMiddleware(call, options) {
    if (options.deadline == null) {
        return yield* call.next(call.request, options);
    }
    const { deadline, signal: origSignal, ...restOptions } = options;
    const abortController = new node_abort_controller_1.default();
    const abortListener = () => {
        abortController.abort();
    };
    origSignal === null || origSignal === void 0 ? void 0 : origSignal.addEventListener('abort', abortListener);
    let timedOut = false;
    const offset = deadline instanceof Date ? deadline.getTime() - Date.now() : deadline;
    const timer = setTimeout(() => {
        timedOut = true;
        abortController.abort();
    }, offset);
    try {
        return yield* call.next(call.request, {
            ...restOptions,
            signal: abortController.signal,
        });
    }
    finally {
        origSignal === null || origSignal === void 0 ? void 0 : origSignal.removeEventListener('abort', abortListener);
        clearTimeout(timer);
        if (timedOut) {
            throw new nice_grpc_common_1.ClientError(call.method.path, nice_grpc_common_1.Status.DEADLINE_EXCEEDED, 'Deadline exceeded');
        }
    }
};
exports.deadlineMiddleware = deadlineMiddleware;
//# sourceMappingURL=index.js.map